### MOUNTED ON GOOGLE DRIVE USING GOOGLE COLAB ###
from google.colab import drive
drive.mount('/content/drive')

### INSTAL RDF LIB ###
pip install rdflib

### CHECK GRAPH CAN BE PARSED ###

from rdflib import Graph
from rdflib.plugins.parsers.notation3 import BadSyntax

g = Graph()
try:
    g.parse("/content/drive/MyDrive/UU/Period2/KDE/Assignement/databaseV5.ttl", format="turtle")
    print("OK. Triples:", len(g))
except BadSyntax as e:
    print("BadSyntax:", e)
except Exception as e:
    print(type(e).__name__, e)

### EXECUTE QUERY USING CUSTOM SYMPTOMS AS INPUT ###
symps_list = [
   "wd:Q9690",          # fatigue
   "wd:Q38933",          # fever
   "wd:Q81938",          # pain
   "wd:Q186889",         # nausea
   "wd:Q127076"         # vomiting     
]
input_symps = " ".join(symps_list)

q = f"""
PREFIX rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX owl:  <http://www.w3.org/2002/07/owl#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX xsd:  <http://www.w3.org/2001/XMLSchema#>
PREFIX ex:   <http://example.org/med#>
PREFIX wd:   <http://www.wikidata.org/entity/>
PREFIX sym:  <http://example.org/med#symptom/>

SELECT ?disease ?label
       ?catNorm
       ?baseScore ?finalScore
WHERE {{
  
  ### USER INPUT SYMPTOMS ###
  VALUES ?inSym {{ {input_symps} }}

  ### DISEASE + LABEL ###
  ?disease a ex:Disease ;
           skos:prefLabel ?label .
  FILTER(lang(?label) = "en")

 
  ### COUNT INPUT SYMPTOMS ###
  {{
    SELECT (COUNT(DISTINCT ?in) AS ?inputCount)
    WHERE {{
      VALUES ?in {{ {input_symps} }}
    }}
  }}

  ### MATCHED COUNT: COUNT INPUT SYMPTOMS EXISTING IN DEASEASE SYMPTOMATOLOGY ###
  {{
    SELECT ?disease (COUNT(DISTINCT ?m) AS ?matchedCount)
    WHERE {{
      VALUES ?m {{ {input_symps} }}
      ?disease (ex:hasPrimarySymptom|ex:hasSecondarySymptom) ?m .
    }}
    GROUP BY ?disease
  }}

  ### DISEASE TOTAL SYMPTOMS ###
  {{
    SELECT ?disease (COUNT(DISTINCT ?sAll) AS ?diseaseSymptomCount)
    WHERE {{
      ?disease (ex:hasPrimarySymptom|ex:hasSecondarySymptom) ?sAll .
    }}
    GROUP BY ?disease
  }}

  ### JACCARD SIMILARITY ###
  BIND(
    IF(
      (xsd:decimal(?inputCount) + xsd:decimal(?diseaseSymptomCount) - xsd:decimal(?matchedCount)) = 0,
      0.0,
      xsd:decimal(?matchedCount) /
      (xsd:decimal(?inputCount) + xsd:decimal(?diseaseSymptomCount) - xsd:decimal(?matchedCount))
    ) AS ?jaccard
  )

  ### COVERAGE ###
  BIND(
    IF(
      xsd:decimal(?diseaseSymptomCount) = 0,
      0.0,
      xsd:decimal(?matchedCount) / xsd:decimal(?diseaseSymptomCount)
    ) AS ?coverage
  )


  ### RARE SYMPTOM CONTRIBUTION PER DISEASE ###

  ### IDF RAW: idfRaw(disease) = 1/df(m), df(m) = #diseases containing symptom m ###

  {{
    SELECT ?disease (SUM(?w) AS ?idfRaw)
    WHERE {{
      VALUES ?t {{ {input_symps} }}
      ?disease (ex:hasPrimarySymptom|ex:hasSecondarySymptom) ?t .

      {{
        SELECT ?t (COUNT(DISTINCT ?d2) AS ?df)
        WHERE {{
          ?d2 a ex:Disease ;
              (ex:hasPrimarySymptom|ex:hasSecondarySymptom) ?t .
        }}
        GROUP BY ?t
      }}

      BIND( IF(?df = 0, 0.0, (1.0 / xsd:decimal(?df))) AS ?w )
    }}
    GROUP BY ?disease
  }}

  ### IDF MAX: idfMax = SUM_ ( x in input) --- (1/df(x))  (upper bound for this input) ###
  {{
    SELECT (SUM(?wIn) AS ?idfMax)
    WHERE {{
      VALUES ?x {{ {input_symps} }}

      {{
        SELECT ?x (COUNT(DISTINCT ?d3) AS ?dfIn)
        WHERE {{
          ?d3 a ex:Disease ;
              (ex:hasPrimarySymptom|ex:hasSecondarySymptom) ?x .
        }}
        GROUP BY ?x
      }}

      BIND( IF(?dfIn = 0, 0.0, (1.0 / xsd:decimal(?dfIn))) AS ?wIn )
    }}
  }}

  BIND( IF(?idfMax = 0, 0.0, xsd:decimal(?idfRaw) / xsd:decimal(?idfMax)) AS ?idfNorm )

  
  ### PRIMARY SYMPTOMS MENTIONED IN USER INPUT ###
  OPTIONAL {{
    SELECT ?disease (COUNT(DISTINCT ?cm) AS ?coreMatchedRaw)
    WHERE {{
      VALUES ?cm {{ {input_symps} }}
      ?disease ex:hasPrimarySymptom ?cm .
    }}
    GROUP BY ?disease
  }}
  BIND(COALESCE(?coreMatchedRaw, 0) AS ?coreMatched)

  BIND(
    IF(?coreMatched >= 3, 1.00,
      IF(?coreMatched = 2, 0.90,
        IF(?coreMatched = 1, 0.70, 0.40)
      )
    ) AS ?coreCoeff
  )

  ### SYMPTOM TYPE BONUS ### 
  {{
    SELECT (COUNT(DISTINCT ?pType) AS ?patientCatCount)
    WHERE {{
      VALUES ?s {{ {input_symps} }}
      ?s a ?pType .
      ?pType rdfs:subClassOf ex:Symptom .
    }}
  }}

  OPTIONAL {{
    SELECT ?disease (COUNT(DISTINCT ?overCat) AS ?catOverlapRaw)
    WHERE {{
      VALUES ?s {{ {input_symps} }}

      ?s a ?pType .
      ?pType rdfs:subClassOf ex:Symptom .

      ?disease (ex:hasPrimarySymptom|ex:hasSecondarySymptom) ?ds .
      ?ds a ?dType .
      ?dType rdfs:subClassOf ex:Symptom .

      FILTER(?pType = ?dType)
      BIND(?pType AS ?overCat)
    }}
    GROUP BY ?disease
  }}
  BIND(COALESCE(?catOverlapRaw, 0) AS ?catOverlap)

  BIND(
    IF(?patientCatCount = 0, 0.0,
      xsd:decimal(?catOverlap) / xsd:decimal(?patientCatCount)
    ) AS ?catNorm
  )

  ### TOTAL SCORE FORMULA ###
  BIND( (0.6 * ?idfNorm + 0.2 * ?jaccard + 0.2 * ?coverage) AS ?baseScore )
  BIND( (?baseScore * ?coreCoeff + 0.10 * ?catNorm) AS ?finalScore )
}}
GROUP BY ?disease
ORDER BY DESC(?finalScore)
LIMIT 5
"""

for row in g.query(q):
    print(row)
